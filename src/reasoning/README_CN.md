# 推理模块

## 概述

推理模块为智能合约和区块链代码审计提供高级漏洞扫描和智能分析能力。它实现了复杂的推理算法、基于对话的分析和上下文感知的漏洞检测，以提供高精度的安全评估。

## 核心组件

### VulnerabilityScanner (`scanner.py`)
主要的漏洞检测引擎，具有以下特性：
- **智能扫描**：基于AI的漏洞检测，具备高级推理能力
- **对话模式**：交互式分析，具有对话历史管理
- **多线程处理**：并发扫描以提高性能
- **上下文集成**：与项目上下文和调用图深度集成

### Utils包 (`utils/`)
增强扫描能力的支持工具：

#### 对话管理器 (`utils/dialogue_manager.py`)
高级对话管理系统：
- **对话历史**：维护多次交互间的上下文
- **会话管理**：跟踪项目的分析会话
- **上下文保持**：在对话轮次间保留重要发现
- **内存优化**：智能历史管理以优化性能

#### 扫描工具 (`utils/scan_utils.py`)
专门的扫描工具：
- **过滤函数**：针对性分析的高级过滤
- **结果处理**：智能结果聚合和去重
- **性能优化**：扫描性能增强工具
- **错误处理**：扫描操作的健壮错误管理

## 主要特性

### 🧠 高级推理能力
- **上下文感知分析**：深度理解代码上下文和业务逻辑
- **多步骤推理**：通过多阶段分析进行复杂漏洞检测
- **模式识别**：针对复杂攻击向量的高级模式匹配
- **假阳性减少**：智能过滤以最小化误报

### 💬 基于对话的分析
- **交互模式**：针对复杂场景的对话式分析
- **历史管理**：在多轮分析中维护上下文
- **迭代精化**：通过对话反馈持续改进
- **专家系统**：为复杂案例提供AI驱动的专家咨询

### 🎯 智能合约专业化
- **DeFi协议分析**：去中心化金融协议的专门分析
- **跨链桥安全**：桥接漏洞的高级检测
- **MEV攻击向量**：最大可提取价值漏洞检测
- **治理机制**：DAO和投票系统安全分析

### ⚡ 高性能扫描
- **并发处理**：大型代码库的多线程分析
- **智能优先级**：基于风险评估的智能任务调度
- **资源优化**：高效的内存和CPU利用
- **可扩展架构**：处理不同复杂度和规模的项目

## 架构设计

```
推理模块
├── VulnerabilityScanner (主引擎)
│   ├── 标准模式扫描
│   ├── 对话模式分析
│   ├── 线程管理
│   └── AI模型集成
└── Utils (支持组件)
    └── ScanUtils
        ├── 过滤函数
        ├── 结果处理
        └── 性能优化
```

## 扫描模式

### 标准模式
传统漏洞扫描，具有：
- **批处理**：多函数的高效分析
- **并行执行**：性能导向的并发扫描
- **结果聚合**：智能结果编译
- **进度跟踪**：实时扫描进度监控

### 对话模式
交互式分析，特色包括：
- **对话界面**：与AI的自然语言交互
- **上下文连续性**：维护对话历史
- **专家咨询**：访问专门知识库
- **迭代分析**：通过多轮对话进行精化

## 使用示例

### 基础漏洞扫描
```python
from reasoning.scanner import VulnerabilityScanner

# 使用项目审计数据初始化扫描器
scanner = VulnerabilityScanner(project_audit)

# 执行标准扫描
results = scanner.do_scan(task_manager, is_gpt4=True)
```

### 对话模式分析
```python
import os

# 启用对话模式
os.environ["ENABLE_DIALOGUE_MODE"] = "true"

# 扫描器将自动使用对话模式
results = scanner.do_scan(task_manager, filter_func=custom_filter)
```

### 自定义过滤
```python
# 定义自定义过滤函数
def high_risk_filter(task):
    return task.risk_level >= 8

# 在扫描期间应用自定义过滤
results = scanner.do_scan(
    task_manager, 
    filter_func=high_risk_filter,
    is_gpt4=True
)
```


## 集成接口

### 输入依赖
- **项目审计**：TreeSitterProjectAudit用于代码结构分析
- **任务管理器**：ProjectTaskMgr用于任务生命周期管理
- **提示词工厂**：用于AI交互的高级提示工程
- **OpenAI API**：与GPT模型的集成分析

### 输出消费者
- **验证模块**：接收扫描结果进行验证
- **结果处理器**：聚合和处理扫描发现
- **报告系统**：生成全面的安全报告
- **数据库存储**：持久化发现以供历史分析

## 配置选项

模块通过环境变量支持各种配置：

- `ENABLE_DIALOGUE_MODE`：启用/禁用交互对话模式
- `MAX_CONCURRENT_SCANS`：控制并行扫描线程数
- `DIALOGUE_HISTORY_LIMIT`：设置对话历史保留限制
- `SCAN_TIMEOUT`：配置单次扫描的超时时间

## AI模型集成

### 支持的模型
- **GPT-4**：高级推理和分析能力
- **GPT-3.5**：标准用例的高效扫描
- **Claude**：多样化视角的替代AI模型
- **自定义模型**：集成额外AI模型的框架

### 提示工程
- **动态提示**：上下文感知的提示生成
- **模型特定优化**：针对不同AI模型的定制提示
- **思维链**：多步骤推理提示策略
- **安全措施**：强大的提示注入防护

## 性能优化

### 扫描效率
- **智能批处理**：性能导向的最优任务分组
- **内存管理**：大型项目的高效内存使用
- **缓存策略**：分析结果的智能缓存
- **资源监控**：实时资源使用跟踪

### 质量保证
- **结果验证**：扫描结果的自动验证
- **一致性检查**：不同分析方法间的交叉验证
- **置信度评分**：发现的可靠性指标
- **持续学习**：通过反馈分析改进

## 错误处理和恢复力

- **优雅降级**：尽管部分失败仍继续操作
- **重试机制**：针对瞬时失败的智能重试策略
- **错误恢复**：扫描中断的自动恢复
- **日志集成**：用于调试和监控的全面日志记录

## 未来增强

- **机器学习集成**：用于模式识别的高级ML模型
- **协作分析**：复杂分析的多智能体系统
- **实时扫描**：持续监控和分析能力
- **自定义规则引擎**：用户定义的漏洞检测规则